From 5cb0fb9e7463e9d7fd31e4c435e068de3d3dadc6 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?St=C3=A9phane=20Graber?= <stgraber@stgraber.org>
Date: Fri, 18 Jul 2025 01:58:49 +0200
Subject: [PATCH 1/2] incusd/images: Restrict public image listing to default
 project
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Stéphane Graber <stgraber@stgraber.org>
---
 cmd/incusd/images.go | 15 ++++++++++++---
 1 file changed, 12 insertions(+), 3 deletions(-)

diff --git a/cmd/incusd/images.go b/cmd/incusd/images.go
index fef7a6aae32..ef55baf62b7 100644
--- a/cmd/incusd/images.go
+++ b/cmd/incusd/images.go
@@ -1786,17 +1786,19 @@ func doImagesGet(ctx context.Context, tx *db.ClusterTx, recursion bool, projectN
 //	  "500":
 //	    $ref: "#/responses/InternalServerError"
 func imagesGet(d *Daemon, r *http.Request) response.Response {
+	s := d.State()
+
+	// Get the parameters.
 	projectName := request.ProjectParam(r)
 	allProjects := util.IsTrue(r.FormValue("all-projects"))
 	filterStr := r.FormValue("filter")
 
-	// ProjectParam returns default if not set
+	// Make sure that we're not dealing with conflicting parameters.
 	if allProjects && projectName != api.ProjectDefaultName {
 		return response.BadRequest(fmt.Errorf("Cannot specify a project when requesting all projects"))
 	}
 
-	s := d.State()
-
+	// Check if the user is authenticated and what kind of access they may have.
 	hasPermission, authorizationErr := s.Authorizer.GetPermissionChecker(r.Context(), r, auth.EntitlementCanView, auth.ObjectTypeImage)
 	if authorizationErr != nil && !api.StatusErrorCheck(authorizationErr, http.StatusForbidden) {
 		return response.SmartError(authorizationErr)
@@ -1804,11 +1806,18 @@ func imagesGet(d *Daemon, r *http.Request) response.Response {
 
 	public := d.checkTrustedClient(r) != nil || authorizationErr != nil
 
+	// For unauthenticated/public requests, only the default profile may be queried.
+	if public && (projectName != api.ProjectDefaultName || allProjects) {
+		return response.BadRequest(errors.New("Unauthenticated image queries are only possible against the default project"))
+	}
+
+	// Process the filters.
 	clauses, err := filter.Parse(filterStr, filter.QueryOperatorSet())
 	if err != nil {
 		return response.SmartError(fmt.Errorf("Invalid filter: %w", err))
 	}
 
+	// Get the image list.
 	var result any
 	err = s.DB.Cluster.Transaction(r.Context(), func(ctx context.Context, tx *db.ClusterTx) error {
 		result, err = doImagesGet(ctx, tx, localUtil.IsRecursionRequest(r), projectName, public, clauses, hasPermission, allProjects)

From 8d817f1a4ceea0599301f3240ade070b0fd5d86c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?St=C3=A9phane=20Graber?= <stgraber@stgraber.org>
Date: Fri, 18 Jul 2025 01:59:17 +0200
Subject: [PATCH 2/2] incusd/images: Use identical errors for all not-found
 cases on public endpoints
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Stéphane Graber <stgraber@stgraber.org>
---
 cmd/incusd/images.go | 16 ++++++++++++++--
 1 file changed, 14 insertions(+), 2 deletions(-)

diff --git a/cmd/incusd/images.go b/cmd/incusd/images.go
index ef55baf62b7..b7af0d1854f 100644
--- a/cmd/incusd/images.go
+++ b/cmd/incusd/images.go
@@ -3170,6 +3170,12 @@ func imageGet(d *Daemon, r *http.Request) response.Response {
 		return nil
 	})
 	if err != nil {
+		// As this is a publicly available function, override any 404 to a standard reply.
+		// This avoids leaking information about the image or project existence.
+		if response.IsNotFoundError(err) {
+			return response.NotFound(fmt.Errorf("Image %q not found", fingerprint))
+		}
+
 		return response.SmartError(err)
 	}
 
@@ -3190,7 +3196,7 @@ func imageGet(d *Daemon, r *http.Request) response.Response {
 	}
 
 	if !info.Public && public && op == nil {
-		return response.NotFound(fmt.Errorf("Image %q not found", info.Fingerprint))
+		return response.NotFound(fmt.Errorf("Image %q not found", fingerprint))
 	}
 
 	etag := []any{info.Public, info.AutoUpdate, info.Properties}
@@ -4186,6 +4192,12 @@ func imageExport(d *Daemon, r *http.Request) response.Response {
 		return err
 	})
 	if err != nil {
+		// As this is a publicly available function, override any 404 to a standard reply.
+		// This avoids leaking information about the image or project existence.
+		if response.IsNotFoundError(err) {
+			return response.NotFound(fmt.Errorf("Image %q not found", fingerprint))
+		}
+
 		return response.SmartError(err)
 	}
 
@@ -4217,7 +4229,7 @@ func imageExport(d *Daemon, r *http.Request) response.Response {
 		}
 
 		if !imgInfo.Public && public && op == nil {
-			return response.NotFound(fmt.Errorf("Image %q not found", imgInfo.Fingerprint))
+			return response.NotFound(fmt.Errorf("Image %q not found", fingerprint))
 		}
 	}
 
