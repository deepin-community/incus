From 7e1186ab368257c0bdeb0465c9c693596f04e12f Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?St=C3=A9phane=20Graber?= <stgraber@stgraber.org>
Date: Fri, 18 Jul 2025 02:27:25 +0200
Subject: [PATCH 1/2] internal/util: Add recursion limit to RenderTemplate
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Stéphane Graber <stgraber@stgraber.org>
---
 internal/util/template.go | 38 +++++++++++++++++++++++---------------
 1 file changed, 23 insertions(+), 15 deletions(-)

diff --git a/internal/util/template.go b/internal/util/template.go
index e790133e710..4a963746c6b 100644
--- a/internal/util/template.go
+++ b/internal/util/template.go
@@ -1,29 +1,37 @@
 package util
 
 import (
+	"errors"
 	"strings"
 
 	"github.com/flosch/pongo2"
 )
 
-// RenderTemplate renders a pongo2 template.
+// RenderTemplate renders a pongo2 template with nesting support.
+// This supports up to 3 levels of nesting (to avoid loops).
 func RenderTemplate(template string, ctx pongo2.Context) (string, error) {
-	// Load template from string
-	tpl, err := pongo2.FromString("{% autoescape off %}" + template + "{% endautoescape %}")
-	if err != nil {
-		return "", err
-	}
+	// Limit recursion to 3 levels.
+	for range 3 {
+		// Load template from string
+		tpl, err := pongo2.FromString("{% autoescape off %}" + template + "{% endautoescape %}")
+		if err != nil {
+			return "", err
+		}
 
-	// Get rendered template
-	ret, err := tpl.Execute(ctx)
-	if err != nil {
-		return ret, err
-	}
+		// Get rendered template
+		ret, err := tpl.Execute(ctx)
+		if err != nil {
+			return ret, err
+		}
+
+		// Check if another pass is needed.
+		if !strings.Contains(ret, "{{") && !strings.Contains(ret, "{%") {
+			return ret, nil
+		}
 
-	// Looks like we're nesting templates so run pongo again
-	if strings.Contains(ret, "{{") || strings.Contains(ret, "{%") {
-		return RenderTemplate(ret, ctx)
+		// Prepare for another run.
+		template = ret
 	}
 
-	return ret, err
+	return "", errors.New("Maximum template recursion limit reached")
 }

From 630d850d40bf25428b36860cd87728f34191bca9 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?St=C3=A9phane=20Graber?= <stgraber@stgraber.org>
Date: Fri, 18 Jul 2025 02:30:50 +0200
Subject: [PATCH 2/2] internal/util: Tweak common pongo2 parser to block
 dangerous functions
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Stéphane Graber <stgraber@stgraber.org>
---
 internal/util/template.go | 14 +++++++++++++-
 1 file changed, 13 insertions(+), 1 deletion(-)

diff --git a/internal/util/template.go b/internal/util/template.go
index 4a963746c6b..29eaa66756e 100644
--- a/internal/util/template.go
+++ b/internal/util/template.go
@@ -2,6 +2,7 @@ package util
 
 import (
 	"errors"
+	"fmt"
 	"strings"
 
 	"github.com/flosch/pongo2"
@@ -10,10 +11,21 @@ import (
 // RenderTemplate renders a pongo2 template with nesting support.
 // This supports up to 3 levels of nesting (to avoid loops).
 func RenderTemplate(template string, ctx pongo2.Context) (string, error) {
+	// Prepare a custom set.
+	custom := pongo2.NewSet("render-template", pongo2.DefaultLoader)
+
+	// Block the use of some tags.
+	for _, tag := range []string{"extends", "import", "include", "ssi"} {
+		err := custom.BanTag(tag)
+		if err != nil {
+			return "", fmt.Errorf("Failed to configure custom pongo2 parser: Failed to block tag tag %q: %w", tag, err)
+		}
+	}
+
 	// Limit recursion to 3 levels.
 	for range 3 {
 		// Load template from string
-		tpl, err := pongo2.FromString("{% autoescape off %}" + template + "{% endautoescape %}")
+		tpl, err := custom.FromString("{% autoescape off %}" + template + "{% endautoescape %}")
 		if err != nil {
 			return "", err
 		}
