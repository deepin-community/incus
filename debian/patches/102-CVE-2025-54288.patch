From 25cc63ece8f74ef2c7f9a445d544338b91340af7 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?St=C3=A9phane=20Graber?= <stgraber@stgraber.org>
Date: Thu, 17 Jul 2025 01:58:06 +0200
Subject: [PATCH] incusd/dev_incus: Add extra validation for monitor
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

We shouldn't just rely on the process name but also make sure that it's
running outside of the container as this is a unique characteristic of
the real monitor process.

Signed-off-by: St√©phane Graber <stgraber@stgraber.org>
---
 cmd/incusd/dev_incus.go | 12 ++++++------
 1 file changed, 6 insertions(+), 6 deletions(-)

diff --git a/cmd/incusd/dev_incus.go b/cmd/incusd/dev_incus.go
index e72ade71c26..dbc3b25217a 100644
--- a/cmd/incusd/dev_incus.go
+++ b/cmd/incusd/dev_incus.go
@@ -418,7 +418,12 @@ func findContainerForPid(pid int32, s *state.State) (instance.Container, error)
 			return nil, err
 		}
 
-		if strings.HasPrefix(string(cmdline), "[lxc monitor]") {
+		status, err := os.ReadFile(fmt.Sprintf("/proc/%d/status", pid))
+		if err != nil {
+			return nil, err
+		}
+
+		if strings.HasPrefix(string(cmdline), "[lxc monitor]") && strings.Contains(string(status), fmt.Sprintf("NSpid:	%d\n", pid)) {
 			// container names can't have spaces
 			parts := strings.Split(string(cmdline), " ")
 			name := strings.TrimSuffix(parts[len(parts)-1], "\x00")
@@ -442,11 +447,6 @@ func findContainerForPid(pid int32, s *state.State) (instance.Container, error)
 			return inst.(instance.Container), nil
 		}
 
-		status, err := os.ReadFile(fmt.Sprintf("/proc/%d/status", pid))
-		if err != nil {
-			return nil, err
-		}
-
 		re, err := regexp.Compile(`^PPid:\s+([0-9]+)$`)
 		if err != nil {
 			return nil, err
