From c5359c809836c0f3b1e6022bf0528bb90ce06ad7 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?St=C3=A9phane=20Graber?= <stgraber@stgraber.org>
Date: Sun, 9 Nov 2025 18:41:24 -0500
Subject: [PATCH] incusd/storage: Tighten storage pool volume permissions
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Closes #2641

Signed-off-by: St√©phane Graber <stgraber@stgraber.org>
---
 internal/server/storage/backend.go              |  5 +++--
 internal/server/storage/drivers/driver_btrfs.go |  2 +-
 .../server/storage/drivers/driver_zfs_utils.go  |  4 ++--
 internal/server/storage/drivers/generic_vfs.go  |  4 ++--
 internal/server/storage/drivers/volume.go       | 17 +++++++++++------
 5 files changed, 19 insertions(+), 13 deletions(-)

diff --git a/internal/server/storage/backend.go b/internal/server/storage/backend.go
index 2b69c426fa0..43dcaa760a1 100644
--- a/internal/server/storage/backend.go
+++ b/internal/server/storage/backend.go
@@ -6205,9 +6205,10 @@ func (b *backend) RestoreCustomVolume(projectName, volName string, snapshotName
 
 func (b *backend) createStorageStructure(path string) error {
 	for _, volType := range b.driver.Info().VolumeTypes {
-		for _, name := range drivers.BaseDirectories[volType] {
+		for _, name := range drivers.BaseDirectories[volType].Paths {
 			path := filepath.Join(path, name)
-			err := os.MkdirAll(path, 0o711)
+
+			err := os.MkdirAll(path, drivers.BaseDirectories[volType].Mode)
 			if err != nil && !os.IsExist(err) {
 				return fmt.Errorf("Failed to create directory %q: %w", path, err)
 			}
diff --git a/internal/server/storage/drivers/driver_btrfs.go b/internal/server/storage/drivers/driver_btrfs.go
index 5e436aa4776..24cdaa308e1 100644
--- a/internal/server/storage/drivers/driver_btrfs.go
+++ b/internal/server/storage/drivers/driver_btrfs.go
@@ -268,7 +268,7 @@ func (d *btrfs) Delete(op *operations.Operation) error {
 
 	// Delete potential intermediate btrfs subvolumes.
 	for _, volType := range d.Info().VolumeTypes {
-		for _, dir := range BaseDirectories[volType] {
+		for _, dir := range BaseDirectories[volType].Paths {
 			path := filepath.Join(GetPoolMountPath(d.name), dir)
 			if !util.PathExists(path) {
 				continue
diff --git a/internal/server/storage/drivers/driver_zfs_utils.go b/internal/server/storage/drivers/driver_zfs_utils.go
index ae2c80138a3..c2a71e17068 100644
--- a/internal/server/storage/drivers/driver_zfs_utils.go
+++ b/internal/server/storage/drivers/driver_zfs_utils.go
@@ -301,8 +301,8 @@ func (d *zfs) initialDatasets() []string {
 
 	// Iterate over the listed supported volume types.
 	for _, volType := range d.Info().VolumeTypes {
-		entries = append(entries, BaseDirectories[volType][0])
-		entries = append(entries, filepath.Join("deleted", BaseDirectories[volType][0]))
+		entries = append(entries, BaseDirectories[volType].Paths[0])
+		entries = append(entries, filepath.Join("deleted", BaseDirectories[volType].Paths[0]))
 	}
 
 	return entries
diff --git a/internal/server/storage/drivers/generic_vfs.go b/internal/server/storage/drivers/generic_vfs.go
index 8727c003c3a..6489b6b0547 100644
--- a/internal/server/storage/drivers/generic_vfs.go
+++ b/internal/server/storage/drivers/generic_vfs.go
@@ -1151,11 +1151,11 @@ func genericVFSListVolumes(d Driver) ([]Volume, error) {
 	poolMountPath := GetPoolMountPath(poolName)
 
 	for _, volType := range d.Info().VolumeTypes {
-		if len(BaseDirectories[volType]) < 1 {
+		if len(BaseDirectories[volType].Paths) < 1 {
 			return nil, fmt.Errorf("Cannot get base directory name for volume type %q", volType)
 		}
 
-		volTypePath := filepath.Join(poolMountPath, BaseDirectories[volType][0])
+		volTypePath := filepath.Join(poolMountPath, BaseDirectories[volType].Paths[0])
 		ents, err := os.ReadDir(volTypePath)
 		if err != nil {
 			return nil, fmt.Errorf("Failed to list directory %q for volume type %q: %w", volTypePath, volType, err)
diff --git a/internal/server/storage/drivers/volume.go b/internal/server/storage/drivers/volume.go
index cc503b2ead0..640c614ca25 100644
--- a/internal/server/storage/drivers/volume.go
+++ b/internal/server/storage/drivers/volume.go
@@ -85,13 +85,18 @@ const ContentTypeISO = ContentType("iso")
 // VolumePostHook function returned from a storage action that should be run later to complete the action.
 type VolumePostHook func(vol Volume) error
 
+type baseDirectory struct {
+	Paths []string
+	Mode  os.FileMode
+}
+
 // BaseDirectories maps volume types to the expected directories.
-var BaseDirectories = map[VolumeType][]string{
-	VolumeTypeBucket:    {"buckets"},
-	VolumeTypeContainer: {"containers", "containers-snapshots"},
-	VolumeTypeCustom:    {"custom", "custom-snapshots"},
-	VolumeTypeImage:     {"images"},
-	VolumeTypeVM:        {"virtual-machines", "virtual-machines-snapshots"},
+var BaseDirectories = map[VolumeType]baseDirectory{
+	VolumeTypeBucket:    {Paths: []string{"buckets"}, Mode: 0o711},
+	VolumeTypeContainer: {Paths: []string{"containers", "containers-snapshots"}, Mode: 0o711},
+	VolumeTypeCustom:    {Paths: []string{"custom", "custom-snapshots"}, Mode: 0o700},
+	VolumeTypeImage:     {Paths: []string{"images"}, Mode: 0o700},
+	VolumeTypeVM:        {Paths: []string{"virtual-machines", "virtual-machines-snapshots"}, Mode: 0o700},
 }
 
 // Volume represents a storage volume, and provides functions to mount and unmount it.
